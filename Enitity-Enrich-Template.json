{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
    "logicAppName": {
        "type": "string",
        "metadata": {
            "description": "Name of the Logic App"
        }
    },
    "location": {
        "type": "string",
        "defaultValue": "ukwest",
        "metadata": {
            "description": "Location for the Logic App"
        }
    },
    "azureSentinelConnectionId": {
        "type": "string",
        "metadata": {
            "description": "ID of the Azure Sentinel connection. Format: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Web/connections/{connectionName}"
        }
    },
    "azureSentinelConnectionName": {
        "type": "string",
        "metadata": {
            "description": "Name of the Azure Sentinel connection."
        }
    },
    "virustotalApiKey": {
        "type": "securestring",
        "metadata": {
            "description": "API Key for virustotal"
        }
    },
    "AbusedIPDBApiKey": {
        "type": "securestring",
        "metadata": {
            "description": "AbusedIPDB Api Key "
        }
    },
    "WhoisApiKey": {
        "type": "securestring",
        "metadata": {
            "description": "Whois Api Key"
        }
    }
},
    "variables": {},
    "resources": [
        {   
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('logicAppName')]",
            "location": "[parameters('location')]",
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        }
                    },
                    "triggers": {
                        "Microsoft_Sentinel_incident": {
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "body": {
                                    "callback_url": "@{listCallbackUrl()}"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "path": "/incident-creation"
                            }
                        }
                    },
                    "actions": {
                        "Condition": {
                            "actions": {
                                "For_each": {
                                    "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                                    "actions": {
                                        "Compose": {
                                            "runAfter": {
                                                "HTTP": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@body('HTTP')"
                                        },
                                        "Condition_2": {
                                            "actions": {
                                                "Add_comment_to_incident_(V3)": {
                                                    "runAfter": {
                                                        "Update_incident": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@body('Update_incident')?['id']",
                                                            "message": "<p><strong>IP Address</strong>:<span style=\"color: rgb(41,105,176)\"> </span><span style=\"color: rgb(41,105,176)\">@{replace(items('For_each')?['Address'], '.', '[.]')}</span><span style=\"color: rgb(41,105,176)\"></span><br>\n<strong>ISP</strong>: <span style=\"color: rgb(41,105,176)\"></span><span style=\"color: rgb(41,105,176)\">@{body('Parse_JSON')?['data']?['isp']}</span><span style=\"color: rgb(41,105,176)\"></span><br>\n<strong>Domain</strong>: &nbsp;<span style=\"color: rgb(41,105,176)\"></span><span style=\"color: rgb(41,105,176)\">@{replace(body('Parse_JSON')?['data']?['domain'], '.', '[.]')}</span><span style=\"color: rgb(41,105,176)\"></span><br>\n<strong>Country</strong>: <span style=\"color: rgb(41,105,176)\"></span><span style=\"color: rgb(41,105,176)\">@{body('Parse_JSON')?['data']?['countryName']}</span><span style=\"color: rgb(41,105,176)\"></span><br>\n<strong>Threat Categories</strong>: &nbsp;<span style=\"color: rgb(184,49,47)\"></span><span style=\"color: rgb(184,49,47)\">@{variables('IP Category')}</span><span style=\"color: rgb(184,49,47)\"></span><br>\n<strong>Abuse Confidence Score</strong>: <span style=\"color: rgb(226,80,65)\">&nbsp;</span><span style=\"color: rgb(226,80,65)\">@{body('Parse_JSON')?['data']?['abuseConfidenceScore']}</span><span style=\"color: rgb(226,80,65)\"> %</span></p>"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/Incidents/Comment"
                                                    }
                                                },
                                                "For_each_2": {
                                                    "foreach": "@body('Parse_JSON')?['data']?['reports']",
                                                    "actions": {
                                                        "For_each_3": {
                                                            "foreach": "@items('For_each_2')?['categories']",
                                                            "actions": {
                                                                "Switch": {
                                                                    "runAfter": {},
                                                                    "cases": {
                                                                        "Case": {
                                                                            "case": 1,
                                                                            "actions": {
                                                                                "Condition_3": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "DNS Compromise"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "DNS Compromise"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_10": {
                                                                            "case": 10,
                                                                            "actions": {
                                                                                "Condition_12": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_10": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Web Spam"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Web Spam"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_11": {
                                                                            "case": 11,
                                                                            "actions": {
                                                                                "Condition_13": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_11": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Email Spam"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Email Spam"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_12": {
                                                                            "case": 12,
                                                                            "actions": {
                                                                                "Condition_14": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_12": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Blog Spam"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Blog Spam"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_13": {
                                                                            "case": 13,
                                                                            "actions": {
                                                                                "Condition_15": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_13": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "VPN IP"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "VPN IP"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_14": {
                                                                            "case": 14,
                                                                            "actions": {
                                                                                "Condition_16": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_14": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Port Scan"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Port Scan"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_15": {
                                                                            "case": 15,
                                                                            "actions": {
                                                                                "Condition_17": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_15": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Hacking"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Hacking"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_16": {
                                                                            "case": 16,
                                                                            "actions": {
                                                                                "Condition_18": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_16": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "SQL Injection"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "SQL Injection"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_17": {
                                                                            "case": 17,
                                                                            "actions": {
                                                                                "Condition_19": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_17": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Spoofing"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Spoofing"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_18": {
                                                                            "case": 18,
                                                                            "actions": {
                                                                                "Condition_20": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_19": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Brute-Force"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Brute-Force"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_19": {
                                                                            "case": 19,
                                                                            "actions": {
                                                                                "Condition_21": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_18": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Bad Web Bot"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Bad Web Bot"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_2": {
                                                                            "case": 2,
                                                                            "actions": {
                                                                                "Condition_4": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_2": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "DNS Poisoning"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "DNS Poisoning"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_20": {
                                                                            "case": 20,
                                                                            "actions": {
                                                                                "Condition_22": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_20": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Exploited Host"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Exploited Host"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_21": {
                                                                            "case": 21,
                                                                            "actions": {
                                                                                "Condition_23": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_21": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Web App Attack"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Web App Attack"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_22": {
                                                                            "case": 22,
                                                                            "actions": {
                                                                                "Condition_24": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_22": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "SSH"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "SSH"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_23": {
                                                                            "case": 23,
                                                                            "actions": {
                                                                                "Condition_25": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_23": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "IoT Targeted"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "IoT Targeted\t"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_3": {
                                                                            "case": 3,
                                                                            "actions": {
                                                                                "Condition_5": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_3": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Fraud Orders"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Fraud Orders"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_4": {
                                                                            "case": 4,
                                                                            "actions": {
                                                                                "Condition_6": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_4": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "DDoS Attack"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "DDoS Attack"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_5": {
                                                                            "case": 5,
                                                                            "actions": {
                                                                                "Condition_7": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_5": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "FTP Brute-Force"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "FTP Brute-Force"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_6": {
                                                                            "case": 6,
                                                                            "actions": {
                                                                                "Condition_8": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_6": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Ping of Death"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Ping of Death"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_7": {
                                                                            "case": 7,
                                                                            "actions": {
                                                                                "Condition_9": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_7": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Phishing"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Phishing"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_8": {
                                                                            "case": 8,
                                                                            "actions": {
                                                                                "Condition_10": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_8": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Fraud VoIP"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Fraud VoIP"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Case_9": {
                                                                            "case": 9,
                                                                            "actions": {
                                                                                "Condition_11": {
                                                                                    "actions": {
                                                                                        "Append_to_array_variable_9": {
                                                                                            "runAfter": {},
                                                                                            "type": "AppendToArrayVariable",
                                                                                            "inputs": {
                                                                                                "name": "IP Category",
                                                                                                "value": "Open Proxy"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@variables('IP Category')",
                                                                                                        "Open Proxy"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "default": {
                                                                        "actions": {}
                                                                    },
                                                                    "expression": "@items('For_each_3')",
                                                                    "type": "Switch"
                                                                }
                                                            },
                                                            "runAfter": {},
                                                            "type": "Foreach"
                                                        }
                                                    },
                                                    "runAfter": {},
                                                    "type": "Foreach"
                                                },
                                                "Update_incident": {
                                                    "runAfter": {
                                                        "For_each_2": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                            "tagsToAdd": {
                                                                "TagsToAdd": [
                                                                    {
                                                                        "Tag": "@{replace(items('For_each')?['Address'], '.', '[.]')} - @{body('Parse_JSON')?['data']?['isp']} - @{body('Parse_JSON')?['data']?['countryName']}"
                                                                    },
                                                                    {
                                                                        "Tag": "Confidence Score: @{body('Parse_JSON')?['data']?['abuseConfidenceScore']}"
                                                                    }
                                                                ]
                                                            }
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "put",
                                                        "path": "/Incidents"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Parse_JSON": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "Update_incident_2": {
                                                        "runAfter": {},
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "body": {
                                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                "tagsToAdd": {
                                                                    "TagsToAdd": [
                                                                        {
                                                                            "Tag": " @{items('For_each')?['Address']} - @{body('Parse_JSON')?['data']?['isp']} - @{body('Parse_JSON')?['data']?['countryName']}"
                                                                        },
                                                                        {
                                                                            "Tag": "Non-Malcious Reputation with this IP"
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                }
                                                            },
                                                            "method": "put",
                                                            "path": "/Incidents"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@body('Parse_JSON')?['data']?['reports']",
                                                                ""
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "HTTP": {
                                            "runAfter": {},
                                            "type": "Http",
                                            "inputs": {
                                                "headers": {
                                                    "Key": "[parameters('AbusedIPDBApiKey')]"
                                                },
                                                "method": "GET",
                                                "uri": "https://api.abuseipdb.com/api/v2/check?ipAddress=@{items('For_each')?['Address']}&maxAgeInDays=30&verbose=true"
                                            }
                                        },
                                        "Parse_JSON": {
                                            "runAfter": {
                                                "Compose": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@outputs('Compose')",
                                                "schema": {
                                                    "properties": {
                                                        "data": {
                                                            "properties": {
                                                                "abuseConfidenceScore": {
                                                                    "type": "integer"
                                                                },
                                                                "countryCode": {
                                                                    "type": "string"
                                                                },
                                                                "countryName": {
                                                                    "type": "string"
                                                                },
                                                                "domain": {
                                                                    "type": "string"
                                                                },
                                                                "hostnames": {
                                                                    "type": "array"
                                                                },
                                                                "ipAddress": {
                                                                    "type": "string"
                                                                },
                                                                "ipVersion": {
                                                                    "type": "integer"
                                                                },
                                                                "isPublic": {
                                                                    "type": "boolean"
                                                                },
                                                                "isTor": {
                                                                    "type": "boolean"
                                                                },
                                                                "isWhitelisted": {
                                                                    "type": [
                                                                        "boolean",
                                                                        "null"
                                                                    ]
                                                                },
                                                                "isp": {
                                                                    "type": "string"
                                                                },
                                                                "lastReportedAt": {
                                                                    "type": [
                                                                        "string",
                                                                        "null"
                                                                    ]
                                                                },
                                                                "numDistinctUsers": {
                                                                    "type": "integer"
                                                                },
                                                                "reports": {
                                                                    "items": {
                                                                        "properties": {
                                                                            "categories": {
                                                                                "items": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "type": "array"
                                                                            },
                                                                            "comment": {
                                                                                "type": [
                                                                                    "string",
                                                                                    "null"
                                                                                ]
                                                                            },
                                                                            "reportedAt": {
                                                                                "type": [
                                                                                    "string",
                                                                                    "null"
                                                                                ]
                                                                            },
                                                                            "reporterCountryCode": {
                                                                                "type": "string"
                                                                            },
                                                                            "reporterCountryName": {
                                                                                "type": "string"
                                                                            },
                                                                            "reporterId": {
                                                                                "type": "integer"
                                                                            }
                                                                        },
                                                                        "required": [
                                                                            "reportedAt",
                                                                            "comment",
                                                                            "categories",
                                                                            "reporterId",
                                                                            "reporterCountryCode",
                                                                            "reporterCountryName"
                                                                        ],
                                                                        "type": "object"
                                                                    },
                                                                    "type": "array"
                                                                },
                                                                "totalReports": {
                                                                    "type": "integer"
                                                                },
                                                                "usageType": {
                                                                    "type": [
                                                                        "string",
                                                                        "null"
                                                                    ]
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "type": "Foreach"
                                }
                            },
                            "runAfter": {
                                "Entities_-_Get_URLs": [
                                    "Succeeded"
                                ]
                            },
                            "expression": {
                                "and": [
                                    {
                                        "not": {
                                            "equals": [
                                                "@body('Entities_-_Get_IPs')?['IPs']",
                                                null
                                            ]
                                        }
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Condition_33": {
                            "actions": {
                                "URLSS": {
                                    "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                                    "actions": {
                                        "Add_comment_to_incident_(V3)_6": {
                                            "runAfter": {
                                                "Compose_4": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                    "message": "<p><strong>URL</strong>: @{variables('WhoURL')}, Domain Name: @{body('Parse_JSON_4')?['WhoisRecord']?['domainName']}<br>\n<strong>Created Date:</strong> @{body('Parse_JSON_4')?['WhoisRecord']?['registryData']?['createdDateNormalized']},<strong> Expires</strong>: &nbsp;@{body('Parse_JSON_4')?['WhoisRecord']?['registryData']?['expiresDateNormalized']}<br>\n<strong>Age</strong>: @{body('Parse_JSON_4')?['WhoisRecord']?['estimatedDomainAge']}<br>\n<strong>Registrar Org</strong>: @{body('Parse_JSON_4')?['WhoisRecord']?['registrarName']}, &nbsp;Country: @{body('Parse_JSON_4')?['WhoisRecord']?['administrativeContact']?['country']},@{body('Parse_JSON_4')?['WhoisRecord']?['administrativeContact']?['countryCode']}<br>\n<strong>Host names</strong>: @{body('Parse_JSON_4')?['WhoisRecord']?['nameServers']?['hostNames']}@{body('Parse_JSON_4')?['WhoisRecord']?['nameServers']?['hostNames']}<br>\n<strong>IPs</strong>: &nbsp;@{body('Parse_JSON_4')?['WhoisRecord']?['registryData']?['nameServers']?['ips']}<br>\nWhois Server: @{body('Parse_JSON_4')?['WhoisRecord']?['registryData']?['whoisServer']}</p>"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/Incidents/Comment"
                                            }
                                        },
                                        "Compose_4": {
                                            "runAfter": {
                                                "HTTP_5": [
                                                    "Succeeded"
                                                ],
                                                "Parse_JSON_4": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@variables('64URLwho')"
                                        },
                                        "HTTP_4": {
                                            "runAfter": {
                                                "Set_variable_5": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "method": "GET",
                                                "queries": {
                                                    "apiKey": "[parameters('whoisxmlapi')]",
                                                    "domainName": "@variables('WhoHost')",
                                                    "outputFormat": "JSON"
                                                },
                                                "uri": "https://www.whoisxmlapi.com/whoisserver/WhoisService?"
                                            }
                                        },
                                        "HTTP_5": {
                                            "runAfter": {
                                                "Set_variable_7": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "headers": {
                                                    "x-apikey": "[parameters('virustotalApiKey')]"
                                                },
                                                "method": "GET",
                                                "uri": "https://www.virustotal.com/api/v3/urls/@{variables('64URLwho')}"
                                            }
                                        },
                                        "Parse_JSON_4": {
                                            "runAfter": {
                                                "HTTP_4": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('HTTP_4')",
                                                "schema": {
                                                    "properties": {
                                                        "WhoisRecord": {
                                                            "properties": {
                                                                "administrativeContact": {
                                                                    "properties": {
                                                                        "country": {
                                                                            "type": "string"
                                                                        },
                                                                        "countryCode": {
                                                                            "type": "string"
                                                                        },
                                                                        "organization": {
                                                                            "type": "string"
                                                                        },
                                                                        "rawText": {
                                                                            "type": "string"
                                                                        },
                                                                        "state": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "audit": {
                                                                    "properties": {
                                                                        "createdDate": {
                                                                            "type": "string"
                                                                        },
                                                                        "updatedDate": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "contactEmail": {
                                                                    "type": "string"
                                                                },
                                                                "createdDate": {
                                                                    "type": "string"
                                                                },
                                                                "createdDateNormalized": {
                                                                    "type": "string"
                                                                },
                                                                "domainAvailability": {
                                                                    "type": "string"
                                                                },
                                                                "domainName": {
                                                                    "type": "string"
                                                                },
                                                                "domainNameExt": {
                                                                    "type": "string"
                                                                },
                                                                "estimatedDomainAge": {
                                                                    "type": "integer"
                                                                },
                                                                "expiresDate": {
                                                                    "type": "string"
                                                                },
                                                                "expiresDateNormalized": {
                                                                    "type": "string"
                                                                },
                                                                "footer": {
                                                                    "type": "string"
                                                                },
                                                                "header": {
                                                                    "type": "string"
                                                                },
                                                                "nameServers": {
                                                                    "properties": {
                                                                        "hostNames": {
                                                                            "items": {
                                                                                "type": "string"
                                                                            },
                                                                            "type": "array"
                                                                        },
                                                                        "ips": {
                                                                            "type": "array"
                                                                        },
                                                                        "rawText": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "parseCode": {
                                                                    "type": "integer"
                                                                },
                                                                "rawText": {
                                                                    "type": "string"
                                                                },
                                                                "registrant": {
                                                                    "properties": {
                                                                        "country": {
                                                                            "type": "string"
                                                                        },
                                                                        "countryCode": {
                                                                            "type": "string"
                                                                        },
                                                                        "organization": {
                                                                            "type": "string"
                                                                        },
                                                                        "rawText": {
                                                                            "type": "string"
                                                                        },
                                                                        "state": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "registrarIANAID": {
                                                                    "type": "string"
                                                                },
                                                                "registrarName": {
                                                                    "type": "string"
                                                                },
                                                                "registryData": {
                                                                    "properties": {
                                                                        "audit": {
                                                                            "properties": {
                                                                                "createdDate": {
                                                                                    "type": "string"
                                                                                },
                                                                                "updatedDate": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "createdDate": {
                                                                            "type": "string"
                                                                        },
                                                                        "createdDateNormalized": {
                                                                            "type": "string"
                                                                        },
                                                                        "domainName": {
                                                                            "type": "string"
                                                                        },
                                                                        "expiresDate": {
                                                                            "type": "string"
                                                                        },
                                                                        "expiresDateNormalized": {
                                                                            "type": "string"
                                                                        },
                                                                        "footer": {
                                                                            "type": "string"
                                                                        },
                                                                        "header": {
                                                                            "type": "string"
                                                                        },
                                                                        "nameServers": {
                                                                            "properties": {
                                                                                "hostNames": {
                                                                                    "items": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "ips": {
                                                                                    "type": "array"
                                                                                },
                                                                                "rawText": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "parseCode": {
                                                                            "type": "integer"
                                                                        },
                                                                        "rawText": {
                                                                            "type": "string"
                                                                        },
                                                                        "registrarIANAID": {
                                                                            "type": "string"
                                                                        },
                                                                        "registrarName": {
                                                                            "type": "string"
                                                                        },
                                                                        "status": {
                                                                            "type": "string"
                                                                        },
                                                                        "strippedText": {
                                                                            "type": "string"
                                                                        },
                                                                        "updatedDate": {
                                                                            "type": "string"
                                                                        },
                                                                        "updatedDateNormalized": {
                                                                            "type": "string"
                                                                        },
                                                                        "whoisServer": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "status": {
                                                                    "type": "string"
                                                                },
                                                                "strippedText": {
                                                                    "type": "string"
                                                                },
                                                                "technicalContact": {
                                                                    "properties": {
                                                                        "country": {
                                                                            "type": "string"
                                                                        },
                                                                        "countryCode": {
                                                                            "type": "string"
                                                                        },
                                                                        "organization": {
                                                                            "type": "string"
                                                                        },
                                                                        "rawText": {
                                                                            "type": "string"
                                                                        },
                                                                        "state": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "updatedDate": {
                                                                    "type": "string"
                                                                },
                                                                "updatedDateNormalized": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "Set_variable_5": {
                                            "runAfter": {},
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "WhoHost",
                                                "value": "@{replace(uriHost(items('URLSS')?['Url']), '=', '')}"
                                            }
                                        },
                                        "Set_variable_6": {
                                            "runAfter": {
                                                "Set_variable_5": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "WhoURL",
                                                "value": "https://@{uriHost(items('URLSS')?['Url'])}/"
                                            }
                                        },
                                        "Set_variable_7": {
                                            "runAfter": {
                                                "Set_variable_6": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "64URLwho",
                                                "value": "@{\r\nreplace(base64(variables('WhoURL')), '=', '')\r\n}"
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "type": "Foreach"
                                }
                            },
                            "runAfter": {
                                "Entities_-_Get_URLs": [
                                    "Succeeded"
                                ]
                            },
                            "expression": {
                                "and": [
                                    {
                                        "not": {
                                            "equals": [
                                                "@body('Entities_-_Get_URLs')?['URLs']",
                                                ""
                                            ]
                                        }
                                    },
                                    {
                                        "lessOrEquals": [
                                            "@length(body('Entities_-_Get_URLs')?['URLs'])",
                                            10
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Entities_-_Get_FileHashes": {
                            "runAfter": {
                                "Entities_-_Get_IPs": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/entities/filehash"
                            }
                        },
                        "Entities_-_Get_IPs": {
                            "runAfter": {
                                "Initialize_variable_11": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/entities/ip"
                            }
                        },
                        "Entities_-_Get_URLs": {
                            "runAfter": {
                                "Entities_-_Get_FileHashes": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/entities/url"
                            }
                        },
                        "FileHash": {
                            "foreach": "@body('Entities_-_Get_FileHashes')?['Filehashes']",
                            "actions": {
                                "Condition_28": {
                                    "actions": {
                                        "Condition_32": {
                                            "actions": {
                                                "Add_comment_to_incident_(V3)_5": {
                                                    "runAfter": {
                                                        "Update_incident_8": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                            "message": "<p>File hash @{items('FileHash')?['Value']}: <span style=\"color: rgb(226,80,65)\"><strong>Not found on VT</strong></span></p>"
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/Incidents/Comment"
                                                    }
                                                },
                                                "Update_incident_8": {
                                                    "runAfter": {},
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                            "tagsToAdd": {
                                                                "TagsToAdd": [
                                                                    {
                                                                        "Tag": "File hash  - Not found on VT"
                                                                    }
                                                                ]
                                                            }
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "put",
                                                        "path": "/Incidents"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "HTTP_3": [
                                                    "Succeeded",
                                                    "Failed"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "Add_comment_to_incident_(V3)_4": {
                                                        "runAfter": {
                                                            "Condition_31": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "body": {
                                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                "message": "<p><span style=\"color: rgb(41,105,176)\"><strong>File Name: </strong></span><span style=\"color: rgb(41,105,176)\"><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['meaningful_name']}</strong></span><span style=\"color: rgb(41,105,176)\"><strong></strong></span><strong><br>\n</strong><span style=\"color: rgb(226,80,65)\"><strong>Suggested Threat Label</strong></span><strong>: &nbsp;</strong><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['suggested_threat_label']}</strong><strong><br>\nSize: </strong><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['size']}</strong><strong><br>\n</strong><span style=\"color: rgb(0,0,0)\"><strong>Threat Catefories</strong></span><span style=\"color: rgb(0,0,0)\"><strong>: </strong></span><strong></strong><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['popular_threat_category']}</strong><strong><br>\n</strong><span style=\"color: rgb(0,0,0)\"><strong>Common Threat Name</strong></span><span style=\"color: rgb(0,0,0)\"><strong>: </strong></span><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['popular_threat_name']}</strong><strong><br>\nType Tag: &nbsp;</strong><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['type_tags']}</strong><strong><br>\n</strong><span style=\"color: rgb(84,172,210)\"><strong>Extension</strong></span><strong>: </strong><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['type_extension']}</strong><strong><br>\nTimes Submitted:</strong><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['times_submitted']}</strong><strong> Reputation:</strong><strong>@{body('Parse_JSON_3')?['data']?['attributes']?['reputation']}</strong><strong> %</strong></p>"
                                                            },
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                }
                                                            },
                                                            "method": "post",
                                                            "path": "/Incidents/Comment"
                                                        }
                                                    },
                                                    "Compose_3": {
                                                        "runAfter": {},
                                                        "type": "Compose",
                                                        "inputs": "@body('HTTP_3')"
                                                    },
                                                    "Condition_29": {
                                                        "actions": {
                                                            "For_each_4": {
                                                                "foreach": "@body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['popular_threat_category']",
                                                                "actions": {
                                                                    "Update_incident_4": {
                                                                        "runAfter": {},
                                                                        "type": "ApiConnection",
                                                                        "inputs": {
                                                                            "body": {
                                                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                                "tagsToAdd": {
                                                                                    "TagsToAdd": [
                                                                                        {
                                                                                            "Tag": "Threat Category: @{items('For_each_4')?['value']}"
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            },
                                                                            "host": {
                                                                                "connection": {
                                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                }
                                                                            },
                                                                            "method": "put",
                                                                            "path": "/Incidents"
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {},
                                                                "type": "Foreach"
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Parse_JSON_3": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "not": {
                                                                        "equals": [
                                                                            "@body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['popular_threat_category']",
                                                                            null
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        },
                                                        "type": "If"
                                                    },
                                                    "Condition_30": {
                                                        "actions": {
                                                            "For_each_6": {
                                                                "foreach": "@body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['popular_threat_name']",
                                                                "actions": {
                                                                    "Update_incident_6": {
                                                                        "runAfter": {},
                                                                        "type": "ApiConnection",
                                                                        "inputs": {
                                                                            "body": {
                                                                                "incidentArmId": "@body('Update_incident_5')?['id']",
                                                                                "tagsToAdd": {
                                                                                    "TagsToAdd": [
                                                                                        {
                                                                                            "Tag": "Popular Name: @{items('For_each_6')?['value']}"
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            },
                                                                            "host": {
                                                                                "connection": {
                                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                }
                                                                            },
                                                                            "method": "put",
                                                                            "path": "/Incidents"
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {},
                                                                "type": "Foreach"
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Update_incident_5": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "not": {
                                                                        "equals": [
                                                                            "@body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['popular_threat_name']",
                                                                            null
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        },
                                                        "type": "If"
                                                    },
                                                    "Condition_31": {
                                                        "actions": {
                                                            "Update_incident_7": {
                                                                "runAfter": {},
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "body": {
                                                                        "incidentArmId": "@body('Update_incident_5')?['id']",
                                                                        "tagsToAdd": {
                                                                            "TagsToAdd": [
                                                                                {
                                                                                    "Tag": "Suggested File Label: @{body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['suggested_threat_label']}"
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "put",
                                                                    "path": "/Incidents"
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Condition_30": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "not": {
                                                                        "equals": [
                                                                            "@body('Parse_JSON_3')?['data']?['attributes']?['popular_threat_classification']?['suggested_threat_label']",
                                                                            null
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        },
                                                        "type": "If"
                                                    },
                                                    "Parse_JSON_3": {
                                                        "runAfter": {
                                                            "Compose_3": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "ParseJson",
                                                        "inputs": {
                                                            "content": "@outputs('Compose_3')",
                                                            "schema": {
                                                                "properties": {
                                                                    "data": {
                                                                        "properties": {
                                                                            "attributes": {
                                                                                "properties": {
                                                                                    "authentihash": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "bytehero_info": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "creation_date": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "crowdsourced_yara_results": {
                                                                                        "items": {
                                                                                            "properties": {
                                                                                                "author": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "description": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "match_in_subfile": {
                                                                                                    "type": "boolean"
                                                                                                },
                                                                                                "rule_name": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "ruleset_id": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "ruleset_name": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "source": {
                                                                                                    "type": "string"
                                                                                                }
                                                                                            },
                                                                                            "required": [
                                                                                                "rule_name",
                                                                                                "description",
                                                                                                "author",
                                                                                                "ruleset_id",
                                                                                                "ruleset_name"
                                                                                            ],
                                                                                            "type": "object"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "detectiteasy": {
                                                                                        "properties": {
                                                                                            "filetype": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "values": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "info": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "name": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "type": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "version": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "name"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "first_submission_date": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "last_analysis_date": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "last_analysis_results": {
                                                                                        "properties": {
                                                                                            "Avast": {
                                                                                                "properties": {
                                                                                                    "category": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "engine_name": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "engine_update": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "engine_version": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "method": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "result": {
                                                                                                        "type": [
                                                                                                            "string",
                                                                                                            "null"
                                                                                                        ]
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            },
                                                                                            "Bkav": {
                                                                                                "properties": {
                                                                                                    "category": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "engine_name": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "engine_update": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "engine_version": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "method": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "result": {
                                                                                                        "type": [
                                                                                                            "string",
                                                                                                            "null"
                                                                                                        ]
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "last_analysis_stats": {
                                                                                        "properties": {
                                                                                            "confirmed-timeout": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "failure": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "harmless": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "malicious": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "suspicious": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "timeout": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "type-unsupported": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "undetected": {
                                                                                                "type": "integer"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "last_modification_date": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "last_submission_date": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "magic": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "md5": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "meaningful_name": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "names": {
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "pe_info": {
                                                                                        "properties": {
                                                                                            "compiler_product_versions": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "entry_point": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "exports": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "imphash": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "import_list": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "imported_functions": {
                                                                                                            "items": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "type": "array"
                                                                                                        },
                                                                                                        "library_name": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "library_name",
                                                                                                        "imported_functions"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "machine_type": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "resource_details": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "chi2": {
                                                                                                            "type": "number"
                                                                                                        },
                                                                                                        "entropy": {
                                                                                                            "type": "number"
                                                                                                        },
                                                                                                        "filetype": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "lang": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "sha256": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "type": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "filetype",
                                                                                                        "sha256",
                                                                                                        "type"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "resource_langs": {
                                                                                                "properties": {
                                                                                                    "KOREAN": {
                                                                                                        "type": "integer"
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            },
                                                                                            "resource_types": {
                                                                                                "properties": {
                                                                                                    "RC_BINARY": {
                                                                                                        "type": "integer"
                                                                                                    },
                                                                                                    "RT_VERSION": {
                                                                                                        "type": "integer"
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            },
                                                                                            "rich_pe_header_hash": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "sections": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "chi2": {
                                                                                                            "type": "number"
                                                                                                        },
                                                                                                        "entropy": {
                                                                                                            "type": "number"
                                                                                                        },
                                                                                                        "flags": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "md5": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "name": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "raw_size": {
                                                                                                            "type": "integer"
                                                                                                        },
                                                                                                        "virtual_address": {
                                                                                                            "type": "integer"
                                                                                                        },
                                                                                                        "virtual_size": {
                                                                                                            "type": "integer"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "name",
                                                                                                        "virtual_address",
                                                                                                        "raw_size",
                                                                                                        "entropy",
                                                                                                        "virtual_size",
                                                                                                        "md5"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "timestamp": {
                                                                                                "type": "integer"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "popular_threat_classification": {
                                                                                        "properties": {
                                                                                            "popular_threat_category": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "count": {
                                                                                                            "type": "integer"
                                                                                                        },
                                                                                                        "value": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "count",
                                                                                                        "value"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "popular_threat_name": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "count": {
                                                                                                            "type": "integer"
                                                                                                        },
                                                                                                        "value": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "count",
                                                                                                        "value"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "suggested_threat_label": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "reputation": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "sandbox_verdicts": {
                                                                                        "properties": {
                                                                                            "Lastline": {
                                                                                                "properties": {
                                                                                                    "category": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "malware_classification": {
                                                                                                        "items": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "type": "array"
                                                                                                    },
                                                                                                    "sandbox_name": {
                                                                                                        "type": "string"
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            },
                                                                                            "Yomi Hunter": {
                                                                                                "properties": {
                                                                                                    "category": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "malware_classification": {
                                                                                                        "items": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "type": "array"
                                                                                                    },
                                                                                                    "sandbox_name": {
                                                                                                        "type": "string"
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "sha1": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "sha256": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "signature_info": {
                                                                                        "properties": {
                                                                                            "comments": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "copyright": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "description": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "file version": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "internal name": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "original name": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "product": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "size": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "ssdeep": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "tags": {
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "times_submitted": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "tlsh": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "total_votes": {
                                                                                        "properties": {
                                                                                            "harmless": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "malicious": {
                                                                                                "type": "integer"
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "trid": {
                                                                                        "items": {
                                                                                            "properties": {
                                                                                                "file_type": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "probability": {
                                                                                                    "type": "number"
                                                                                                }
                                                                                            },
                                                                                            "required": [
                                                                                                "file_type",
                                                                                                "probability"
                                                                                            ],
                                                                                            "type": "object"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "type_description": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type_extension": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type_tag": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type_tags": {
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "unique_sources": {
                                                                                        "type": "integer"
                                                                                    },
                                                                                    "vhash": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            },
                                                                            "id": {
                                                                                "type": "string"
                                                                            },
                                                                            "links": {
                                                                                "properties": {
                                                                                    "self": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "type": "object"
                                                                            },
                                                                            "type": {
                                                                                "type": "string"
                                                                            }
                                                                        },
                                                                        "type": "object"
                                                                    }
                                                                },
                                                                "type": "object"
                                                            }
                                                        }
                                                    },
                                                    "Update_incident_5": {
                                                        "runAfter": {
                                                            "Condition_29": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "body": {
                                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                "tagsToAdd": {
                                                                    "TagsToAdd": [
                                                                        {
                                                                            "Tag": "FileName: @{body('Parse_JSON_3')?['data']?['attributes']?['meaningful_name']}  Reputation:  @{body('Parse_JSON_3')?['data']?['attributes']?['reputation']}"
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                }
                                                            },
                                                            "method": "put",
                                                            "path": "/Incidents"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@outputs('HTTP_3')['statusCode']",
                                                            404
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "HTTP_3": {
                                            "runAfter": {},
                                            "type": "Http",
                                            "inputs": {
                                                "headers": {
                                                    "x-apikey": "[parameters('virustotalApiKey')]"
                                                },
                                                "method": "GET",
                                                "uri": "https://www.virustotal.com/api/v3/files/@{items('FileHash')?['Value']}"
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "expression": {
                                        "and": [
                                            {
                                                "less": [
                                                    "@length(body('Entities_-_Get_FileHashes')?['FileHashes'])",
                                                    10
                                                ]
                                            },
                                            {
                                                "or": [
                                                    {
                                                        "contains": [
                                                            "@items('FileHash')?['Algorithm']",
                                                            "SHA256"
                                                        ]
                                                    },
                                                    {
                                                        "contains": [
                                                            "@items('FileHash')?['Algorithm']",
                                                            "SHA1"
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                }
                            },
                            "runAfter": {
                                "Entities_-_Get_URLs": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Foreach"
                        },
                        "Initialize_variable": {
                            "runAfter": {},
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "IP Address",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_10": {
                            "runAfter": {
                                "Initialize_variable_9": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "WhoHost",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_11": {
                            "runAfter": {
                                "Initialize_variable_8": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "64URLwho",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_2": {
                            "runAfter": {
                                "Initialize_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "IP Category",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_3": {
                            "runAfter": {
                                "Initialize_variable_10": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Suggested Label",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_4": {
                            "runAfter": {
                                "Initialize_variable_3": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Is Malicous",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_5": {
                            "runAfter": {
                                "Initialize_variable_4": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "URL",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_6": {
                            "runAfter": {
                                "Initialize_variable_5": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "URL Threat Category",
                                        "type": "object"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_7": {
                            "runAfter": {
                                "Initialize_variable_6": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "File Category",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_8": {
                            "runAfter": {
                                "Initialize_variable_7": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Malware Family",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_variable_9": {
                            "runAfter": {
                                "Initialize_variable_2": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "WhoURL",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "URL_Forloop": {
                            "actions": {
                                "URLS": {
                                    "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                                    "actions": {
                                        "Add_comment_to_incident_(V3)_2": {
                                            "runAfter": {
                                                "Condition_27": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                    "message": "<p><strong>URL: </strong><strong>@{replace(replace(items('URLS')?['Url'], '.', '[.]'), 'http', 'hxxp')}</strong><strong><br>\nThreat Name(s) - &nbsp;</strong><strong>@{body('Parse_JSON_2')?['data']?['attributes']?['threat_names']}</strong><strong><br>\nReputation - </strong><strong>@{body('Parse_JSON_2')?['data']?['attributes']?['reputation']}</strong><strong> </strong><span style=\"color: rgb(243,121,52)\"><strong>%</strong></span><strong><br>\nThreat Categories:</strong><span style=\"color: rgb(184,49,47)\"><strong> </strong></span><strong></strong><strong>@{body('Parse_JSON_2')?['data']?['attributes']?['categories']}</strong><strong><br>\nTitle: </strong><strong>@{body('Parse_JSON_2')?['data']?['attributes']?['title']}</strong><strong><br>\nTags: </strong><strong>@{body('Parse_JSON_2')?['data']?['attributes']?['tags']}</strong><strong></strong></p>"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/Incidents/Comment"
                                            }
                                        },
                                        "Compose_2": {
                                            "runAfter": {
                                                "HTTP_2": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@body('HTTP_2')"
                                        },
                                        "Condition_26": {
                                            "actions": {
                                                "Set_variable_3": {
                                                    "runAfter": {},
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "Is Malicous",
                                                        "value": "Malicious "
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Set_variable_2": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "Set_variable_4": {
                                                        "runAfter": {},
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "Is Malicous",
                                                            "value": "Non-malicious "
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "not": {
                                                            "equals": [
                                                                "@body('Parse_JSON_2')?['data']?['attributes']?['threat_names']",
                                                                null
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Condition_27": {
                                            "actions": {
                                                "Update_incident_3": {
                                                    "runAfter": {},
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                            "tagsToAdd": {
                                                                "TagsToAdd": [
                                                                    {
                                                                        "Tag": "URLs:   @{replace(replace(items('URLS')?['Url'], '.', '[.]'), 'http', 'hxxp')} "
                                                                    },
                                                                    {
                                                                        "Tag": "Tags: @{body('Parse_JSON_2')?['data']?['attributes']?['tags']}"
                                                                    },
                                                                    {
                                                                        "Tag": "File Reputation: @{variables('Is Malicous')}"
                                                                    }
                                                                ]
                                                            }
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "put",
                                                        "path": "/Incidents"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Condition_26": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "Add_comment_to_incident_(V3)_3": {
                                                        "runAfter": {},
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "body": {
                                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                "message": "<p>URL: @{items('URLS')?['Url']}<br>\nThreat Name(s) - &nbsp;@{body('Parse_JSON_2')?['data']?['attributes']?['threat_names']}<br>\nReputation - @{body('Parse_JSON_2')?['data']?['attributes']?['reputation']} %<br>\nThreat Categories: @{body('Parse_JSON_2')?['data']?['attributes']?['categories']}<br>\nTitle: @{body('Parse_JSON_2')?['data']?['attributes']?['title']}<br>\nTags: @{body('Parse_JSON_2')?['data']?['attributes']?['tags']}</p>"
                                                            },
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                }
                                                            },
                                                            "method": "post",
                                                            "path": "/Incidents/Comment"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "or": [
                                                    {
                                                        "not": {
                                                            "contains": [
                                                                "@body('Parse_JSON_2')?['data']?['attributes']?['categories']",
                                                                ""
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        "not": {
                                                            "contains": [
                                                                "@body('Parse_JSON_2')?['data']?['attributes']?['tags']",
                                                                ""
                                                            ]
                                                        }
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "HTTP_2": {
                                            "runAfter": {
                                                "Set_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "headers": {
                                                    "x-apikey": "[parameters('virustotalApiKey')]"
                                                },
                                                "method": "GET",
                                                "uri": "http://www.virustotal.com/api/v3/urls/@{variables('URL')}"
                                            }
                                        },
                                        "Parse_JSON_2": {
                                            "runAfter": {
                                                "Compose_2": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@outputs('Compose_2')",
                                                "schema": {
                                                    "properties": {
                                                        "data": {
                                                            "properties": {
                                                                "attributes": {
                                                                    "properties": {
                                                                        "categories": {
                                                                            "properties": {
                                                                                "Forcepoint ThreatSeeker": {
                                                                                    "type": "string"
                                                                                },
                                                                                "Xcitium Verdict Cloud": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "detectiteasy": {
                                                                            "properties": {
                                                                                "type": {
                                                                                    "type": "string"
                                                                                },
                                                                                "values": {
                                                                                    "items": {
                                                                                        "properties": {
                                                                                            "result": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "version": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "version",
                                                                                            "result"
                                                                                        ],
                                                                                        "type": "object"
                                                                                    },
                                                                                    "type": "array"
                                                                                }
                                                                            },
                                                                            "required": [
                                                                                "type",
                                                                                "values"
                                                                            ],
                                                                            "type": "object"
                                                                        },
                                                                        "first_submission_date": {
                                                                            "type": "integer"
                                                                        },
                                                                        "html_meta": {
                                                                            "properties": {
                                                                                "description": {
                                                                                    "items": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "keywords": {
                                                                                    "items": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "viewport": {
                                                                                    "items": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type": "array"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "last_analysis_date": {
                                                                            "type": "integer"
                                                                        },
                                                                        "last_analysis_results": {
                                                                            "properties": {
                                                                                "Bfore.Ai PreCrime": {
                                                                                    "properties": {
                                                                                        "category": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "engine_name": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "method": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "result": {
                                                                                            "type": [
                                                                                                "string",
                                                                                                "null"
                                                                                            ]
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "Bkav": {
                                                                                    "properties": {
                                                                                        "category": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "engine_name": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "method": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "result": {
                                                                                            "type": [
                                                                                                "string",
                                                                                                "null"
                                                                                            ]
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "last_analysis_stats": {
                                                                            "properties": {
                                                                                "harmless": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "malicious": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "suspicious": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "timeout": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "undetected": {
                                                                                    "type": "integer"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "last_final_url": {
                                                                            "type": "string"
                                                                        },
                                                                        "last_http_response_code": {
                                                                            "type": "integer"
                                                                        },
                                                                        "last_http_response_content_length": {
                                                                            "type": "integer"
                                                                        },
                                                                        "last_http_response_content_sha256": {
                                                                            "type": "string"
                                                                        },
                                                                        "last_http_response_headers": {
                                                                            "properties": {
                                                                                "connection": {
                                                                                    "type": "string"
                                                                                },
                                                                                "content-type": {
                                                                                    "type": "string"
                                                                                },
                                                                                "date": {
                                                                                    "type": "string"
                                                                                },
                                                                                "keep-alive": {
                                                                                    "type": "string"
                                                                                },
                                                                                "server": {
                                                                                    "type": "string"
                                                                                },
                                                                                "transfer-encoding": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "last_modification_date": {
                                                                            "type": "integer"
                                                                        },
                                                                        "last_submission_date": {
                                                                            "type": "integer"
                                                                        },
                                                                        "outgoing_links": {
                                                                            "items": {
                                                                                "type": "string"
                                                                            },
                                                                            "type": "array"
                                                                        },
                                                                        "pe_info": {
                                                                            "properties": {
                                                                                "compiler_product_versions": {
                                                                                    "items": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "entry_point": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "exports": {
                                                                                    "items": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "imphash": {
                                                                                    "type": "string"
                                                                                },
                                                                                "import_list": {
                                                                                    "items": {
                                                                                        "properties": {
                                                                                            "imported_functions": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "library_name": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "library_name",
                                                                                            "imported_functions"
                                                                                        ],
                                                                                        "type": "object"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "machine_type": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "resource_details": {
                                                                                    "items": {
                                                                                        "properties": {
                                                                                            "chi2": {
                                                                                                "type": "number"
                                                                                            },
                                                                                            "entropy": {
                                                                                                "type": "number"
                                                                                            },
                                                                                            "filetype": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "lang": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "sha256": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "type": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "lang",
                                                                                            "entropy",
                                                                                            "chi2",
                                                                                            "filetype",
                                                                                            "sha256",
                                                                                            "type"
                                                                                        ],
                                                                                        "type": "object"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "resource_langs": {
                                                                                    "properties": {
                                                                                        "KOREAN": {
                                                                                            "type": "integer"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "resource_types": {
                                                                                    "properties": {
                                                                                        "RC_BINARY": {
                                                                                            "type": "integer"
                                                                                        },
                                                                                        "RT_VERSION": {
                                                                                            "type": "integer"
                                                                                        }
                                                                                    },
                                                                                    "type": "object"
                                                                                },
                                                                                "rich_pe_header_hash": {
                                                                                    "type": "string"
                                                                                },
                                                                                "sections": {
                                                                                    "items": {
                                                                                        "properties": {
                                                                                            "chi2": {
                                                                                                "type": "number"
                                                                                            },
                                                                                            "entropy": {
                                                                                                "type": "number"
                                                                                            },
                                                                                            "flags": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "md5": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "name": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "raw_size": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "virtual_address": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "virtual_size": {
                                                                                                "type": "integer"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "name",
                                                                                            "chi2",
                                                                                            "virtual_address",
                                                                                            "flags",
                                                                                            "raw_size",
                                                                                            "entropy",
                                                                                            "virtual_size",
                                                                                            "md5"
                                                                                        ],
                                                                                        "type": "object"
                                                                                    },
                                                                                    "type": "array"
                                                                                },
                                                                                "timestamp": {
                                                                                    "type": "integer"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "redirection_chain": {
                                                                            "items": {
                                                                                "type": "string"
                                                                            },
                                                                            "type": "array"
                                                                        },
                                                                        "reputation": {
                                                                            "type": "integer"
                                                                        },
                                                                        "tags": {
                                                                            "type": "array"
                                                                        },
                                                                        "threat_names": {
                                                                            "type": "array"
                                                                        },
                                                                        "times_submitted": {
                                                                            "type": "integer"
                                                                        },
                                                                        "title": {
                                                                            "type": "string"
                                                                        },
                                                                        "tld": {
                                                                            "type": "string"
                                                                        },
                                                                        "total_votes": {
                                                                            "properties": {
                                                                                "harmless": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "malicious": {
                                                                                    "type": "integer"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "trackers": {
                                                                            "properties": {
                                                                                "Google Tag Manager": {
                                                                                    "items": {
                                                                                        "properties": {
                                                                                            "id": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "timestamp": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "url": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "url",
                                                                                            "timestamp",
                                                                                            "id"
                                                                                        ],
                                                                                        "type": "object"
                                                                                    },
                                                                                    "type": "array"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "url": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "id": {
                                                                    "type": "string"
                                                                },
                                                                "links": {
                                                                    "properties": {
                                                                        "self": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "type": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "Set_variable": {
                                            "runAfter": {},
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "URL",
                                                "value": "@{replace(base64(uriHost(items('URLS')?['Url'])), '=', '')}"
                                            }
                                        },
                                        "Set_variable_2": {
                                            "runAfter": {
                                                "Parse_JSON_2": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "URL Threat Category",
                                                "value": "@body('Parse_JSON_2')?['data']?['attributes']?['categories']"
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "type": "Foreach"
                                }
                            },
                            "runAfter": {
                                "Entities_-_Get_URLs": [
                                    "Succeeded"
                                ]
                            },
                            "expression": {
                                "and": [
                                    {
                                        "not": {
                                            "contains": [
                                                "@body('Entities_-_Get_URLs')?['URLs']",
                                                null
                                            ]
                                        }
                                    },
                                    {
                                        "lessOrEquals": [
                                            "@length(body('Entities_-_Get_URLs')?['URLs'])",
                                            12
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azuresentinel": {
                                "connectionId": "[parameters('azureSentinelConnectionId')]",
                                "connectionName": "[parameters('azureSentinelConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('location'), '/managedApis/azuresentinel')]"
                            }
                        }
                    }
                }
            }
        }
    ]
}
